---
section: scope
title: Sweep Scope
---
- Mode: `audit`
- Depth: `quick`
- Areas scanned: policy docs (`README.md`, `AGENTS.md`, `STYLE.md`, `docs/lessons/core.lessons.md`), component READMEs (`dark_core/README.md`, `frontends/dark_cli/README.md`, `frontends/dark_tui/README.md`, `docker/README.md`), ops/process guidance (`.opencode/commands/sweeper.md`, `.opencode/commands/sweep.md`, `.opencode/agents/sweeper.md`), core script entrypoints under `scripts/`
- Methods: targeted file reads, convention checks, command validation for documented script entrypoints
----
---
section: metrics
title: Finding Metrics
---
- Severity counts: `critical=0`, `high=1`, `medium=2`, `low=1`
- Category counts: `style=1`, `dead-code=0`, `docs=1`, `process=1`, `dry=1`
- Total findings: `4`
----
---
section: top-risks
title: Top Risks
---
- Documented command `./scripts/dtui.sh.ts --help` currently fails with permission denied, causing immediate onboarding friction for TUI workflows.
- Runtime convention drift (`process.env` usage in Bun-first codepaths) increases config behavior inconsistency and weakens STYLE.md as a reliable standard.
- Duplicate Prisma `db push` helper logic in production/test paths can diverge under future edits and create subtle migration/test mismatches.
----
---
section: findings
title: Detailed Findings
---
1) Script entrypoint permission drift
- Severity: `high`
- Category: `process`
- Evidence: `scripts/dtui.sh.ts:1`, `scripts/sys_install.sh.ts:1`; `ls -l scripts` shows both as non-executable (`-rw-r--r--`); documented run path in `frontends/dark_tui/README.md:71`; direct invocation check of `./scripts/dtui.sh.ts --help` and `./scripts/sys_install.sh.ts --dry-run` returns `permission denied`.
- Why: shebanged `.sh.ts` entrypoints are expected to be runnable directly; broken execute bits create immediate command failure and docs mismatch.
- Action: restore execute permission (`chmod +x`) on runnable shebang entrypoints, then re-verify documented commands.
- Auto-fix: `no`
- Effort: `S`

2) Bun runtime convention drift (`process.env` in Bun-first paths)
- Severity: `medium`
- Category: `style`
- Evidence: `STYLE.md:36-39`; `dark_core/src/modules/prisma/prisma.client.ts:49`; `dark_core/src/test/helpers/sqlite-test-db.ts:31`, `dark_core/src/test/helpers/sqlite-test-db.ts:76`, `dark_core/src/test/helpers/sqlite-test-db.ts:85`; `prisma.config.ts:6`.
- Why: mixed env APIs reduce predictability and make it harder to reason about runtime behavior and test isolation.
- Action: normalize to `Bun.env` where compatible, and document explicit exceptions where dependency contracts require `process.env`.
- Auto-fix: `no`
- Effort: `M`

3) Duplicated Prisma schema push helper logic
- Severity: `medium`
- Category: `dry`
- Evidence: `dark_core/src/modules/prisma/prisma.client.ts:43`; `dark_core/src/test/helpers/sqlite-test-db.ts:27` both define `runPrismaDbPush` with nearly identical spawn/output/exit handling.
- Why: duplicated operational logic can drift during future edits and produce inconsistent behavior between app startup and integration test setup.
- Action: extract a shared helper (for example under `dark_core/src/modules/prisma/` or `dark_core/src/test/helpers/` with clear ownership) and reuse in both call sites.
- Auto-fix: `no`
- Effort: `M`

4) Root README Moon config list is stale/incomplete
- Severity: `low`
- Category: `docs`
- Evidence: `README.md:65` lists Moon project files but omits `frontends/dark_tui/moon.yml`; source-of-truth list in `AGENTS.md:21-29` includes it.
- Why: partial infra inventories increase reader confusion and encourage drift across setup docs.
- Action: update `README.md` Moon config list to include `frontends/dark_tui/moon.yml` or reference `AGENTS.md` as canonical source.
- Auto-fix: `no`
- Effort: `S`

Supplemental audit checklist
- Exposed-file clarity checks: `pass` (`scripts/dtui.sh.ts`, `scripts/docker_devcontainer.sh.ts`, and command docs are readable with clear intent).
- Markdown durability checks: `warn` (`README.md:65` hardcodes a partial Moon file list that already drifted from canonical guidance).
- Script structure checks: `warn` (`scripts/reflect_constant.sh.ts` at 565 lines and `scripts/helpers/docs_scrape.sh.ts` at 584 lines are large enough to consider focused helper splits; runnable permission failures found at `scripts/dtui.sh.ts` and `scripts/sys_install.sh.ts`).
- Utility extraction checks: `warn` (duplicate `runPrismaDbPush` helpers at `dark_core/src/modules/prisma/prisma.client.ts:43` and `dark_core/src/test/helpers/sqlite-test-db.ts:27`).
- Reporting checks: `pass` (all findings include severity/category/evidence/why/action/auto-fix/effort).
----
---
section: auto-fixes
title: Auto-fixes Applied
---
- None. Run executed in `audit` mode (report-only).
----
---
section: backlog
title: Prioritized Backlog
---
1. Restore executable bits for runnable shebang entrypoints and validate docs examples (`scripts/dtui.sh.ts`, `scripts/sys_install.sh.ts`).
2. Align env handling with `STYLE.md` by replacing `process.env` where safe and documenting justified exceptions.
3. Consolidate duplicated Prisma `db push` invocation logic into one shared helper.
4. Update `README.md` Moon project list (or point to canonical list in `AGENTS.md`).
5. Plan focused decomposition of the two large script files into helper modules without changing behavior.
----
---
section: blockers
title: Blockers And Unknowns
---
- Unknown whether `prisma.config.ts` must retain `process.env` due to Prisma loader expectations in all execution contexts.
- Unknown whether non-executable bits on `scripts/dtui.sh.ts` and `scripts/sys_install.sh.ts` were intentional local hardening or accidental permission drift.
